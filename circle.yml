---
general:
  artifacts:
    - ".release/postgrest"

machine:
  pre:
    # Update Docker & Docker-Compose
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | sudo bash -s -- 1.10.0
    - pip install docker-compose

  services:
    - docker

  environment:
    DOCKER_REPO: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
    # Assumes an empty tag means master branch, e.g. latest release
    DOCKER_IMAGE_TAG: ${CIRCLE_TAG:-latest}
    POSTGREST_SRC: ${POSTGREST_SRC:-/srv/postgrest}
    RELEASE_DIR: ${POSTGREST_SRC}/.release

dependencies:
  cache_directories:
    - "~/.docker"
    # - "~/.stack"
    # - "~/.stack"
    # - ".stack-work"
    # - ".release"

  post:
    - docker info
    - mkdir -p .release
    - mkdir -p .docker
    # - scripts/init_docker.sh
    - scripts/install_deps.sh

    # Setup database for tests
    - createuser --superuser --no-password postgrest_test
    - createdb -O postgrest_test -U ubuntu postgrest_test
test:
  override:
    - echo "Beginning tests..."
    - docker-compose run -e DB_HOST=${HOSTNAME} --no-deps development scripts/run_tests.sh
    # - stack test --test-arguments "--skip \"returns a valid openapi\""
    # - git ls-files | grep '\.l\?hs$' | xargs stack exec -- hlint -X QuasiQuotes -X NoPatternSynonyms "$@"
    # - stack exec -- cabal update
    # - stack exec --no-ghc-package-path -- cabal install --only-d --dry-run
    # - stack exec -- packdeps *.cabal || true
    # - stack exec -- cabal check
    # - stack  --no-haddock-deps
    # - stack sdist
  post:
    - docker-compose run --no-deps development stack install --allow-different-user --local-bin-path $RELEASE_DIR
    - if [[ -e .release/postgrest ]]; then echo 'Postgrest binary exists..'; docker-compose build release; else echo "Postgrest binary does NOT exist"; exit 1; fi
    # - docker run -d -p 3000:3000 ${DOCKER_REPO}; sleep 10
    # - curl --retry 10 --retry-delay 5 -v http://localhost:3000

deployment:
  dockerhub_latest:
    branch: master
    commands:
      - scripts/docker_push.sh

  dockerhub_vtag:
    tag: /^v[0-9]+(\.[0-9]+)*/
    owner: jhr007
    commands:
      - scripts/docker_push.sh
