---
general:
  artifacts:
    - ".release/postgrest"

machine:
  pre:
    # Update Docker & Docker-Compose
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | sudo bash -s -- 1.10.0
    - pip install docker-compose

  services:
    - docker

  environment:
    DOCKER_REPO: ${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
    # Assumes empty tag means branch master, :latest
    DOCKER_IMAGE_TAG: ${CIRCLE_TAG:-latest}
    POSTGREST_SRC: ${POSTGREST_SRC:-/srv/postgrest}
    RELEASE_DIR: ${POSTGREST_SRC}/.release

dependencies:
  cache_directories:
    - "~/.docker"

  override:
    - docker info
    - mkdir -p .release
    - mkdir -p .docker
    - scripts/init_docker.sh

    ## Not Yet carried to this circleci.yml

    # - createuser --superuser --no-password postgrest_test
    # - createdb -O postgrest_test -U ubuntu postgrest_test
test:
  override:
    - echo "Tests go here.. use stack's support for docker here?"
#     - stack test --test-arguments "--skip \"returns a valid openapi\""
#     - git ls-files | grep '\.l\?hs$' | xargs stack exec -- hlint -X QuasiQuotes -X NoPatternSynonyms "$@"
#     - stack exec -- cabal update
#     - stack exec --no-ghc-package-path -- cabal install --only-d --dry-run
#     - stack exec -- packdeps *.cabal || true
#     - stack exec -- cabal check
#     - stack  --no-haddock-deps
#     - stack sdist
  post:
    - docker-compose run --no-deps development stack install --allow-different-user --local-bin-path $RELEASE_DIR
    - if [[ -e .release/postgrest ]]; then echo 'Exists..'; docker-compose build release; else exit 1; fi
    # - docker run -d -p 3000:3000 ${DOCKER_REPO}; sleep 10
    # - curl --retry 10 --retry-delay 5 -v http://localhost:3000

deployment:
  dockerhub_latest:
    branch: master
    commands:
      - scripts/docker_push.sh

  dockerhub_vtag:
    tag: /^v[0-9]+(\.[0-9]+)*/
    owner: jhr007
    commands:
      - scripts/docker_push.sh
